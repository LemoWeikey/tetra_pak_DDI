<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tetra Pak Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            z-index: -2;
        }

        .bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 50%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 50%);
            z-index: -1;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 30px 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 0.8s ease;
        }

        .header h1 {
            font-size: 3em;
            font-weight: 700;
            background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            letter-spacing: -1px;
        }

        .header p {
            color: #94a3b8;
            font-size: 1.1em;
            font-weight: 300;
        }

        .section-divider {
            margin: 40px 0;
            padding: 15px 0;
            border-top: 2px solid rgba(139, 92, 246, 0.3);
            border-bottom: 2px solid rgba(139, 92, 246, 0.3);
        }

        .section-title {
            font-size: 1.8em;
            font-weight: 600;
            color: #fff;
            text-align: center;
            margin: 20px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            animation: fadeInUp 0.8s ease 0.2s both;
        }

        .stat-card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #8b5cf6, #3b82f6);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: rgba(139, 92, 246, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .stat-label {
            font-size: 0.85em;
            color: #94a3b8;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #fff;
            line-height: 1;
        }

        .stat-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2.5em;
            opacity: 0.1;
        }

        .filter-section {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            animation: fadeInUp 0.8s ease 0.4s both;
        }

        .filter-section.with-dropdown {
            margin-bottom: 480px;
        }

        .filter-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .filter-header h3 {
            font-size: 1.2em;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            background: transparent;
            color: #8b5cf6;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: #8b5cf6;
        }

        /* Multi-Select Dropdown for Section 1 */
        .multi-select-container {
            position: relative;
            width: 100%;
            max-width: 600px;
        }

        .multi-select-button {
            width: 100%;
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(59, 130, 246, 0.2) 100%);
            border: 2px solid rgba(139, 92, 246, 0.4);
            border-radius: 12px;
            color: #fff;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .multi-select-button:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3) 0%, rgba(59, 130, 246, 0.3) 100%);
            border-color: rgba(139, 92, 246, 0.6);
            transform: translateY(-2px);
        }

        .multi-select-button .arrow {
            transition: transform 0.3s;
            font-size: 1.2em;
        }

        .multi-select-button.open .arrow {
            transform: rotate(180deg);
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 10px;
            background: rgba(30, 41, 59, 0.98);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(139, 92, 246, 0.4);
            border-radius: 12px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 10000;
            display: none;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .multi-select-dropdown.open {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .multi-select-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .multi-select-actions {
            display: flex;
            gap: 10px;
        }

        .multi-select-actions button {
            padding: 6px 12px;
            background: rgba(139, 92, 246, 0.3);
            border: 1px solid rgba(139, 92, 246, 0.5);
            border-radius: 6px;
            color: #c4b5fd;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .multi-select-actions button:hover {
            background: rgba(139, 92, 246, 0.5);
            color: #fff;
        }

        .multi-select-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .multi-select-item:hover {
            background: rgba(139, 92, 246, 0.2);
            border-left-color: #8b5cf6;
        }

        .multi-select-item input {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
            accent-color: #8b5cf6;
        }

        .multi-select-item label {
            cursor: pointer;
            font-size: 0.95em;
            color: #e2e8f0;
            font-weight: 500;
            flex: 1;
        }

        .multi-select-item.checked {
            background: rgba(139, 92, 246, 0.15);
        }

        .selected-count {
            padding: 4px 12px;
            background: rgba(139, 92, 246, 0.3);
            border-radius: 20px;
            font-size: 0.85em;
            color: #c4b5fd;
            font-weight: 600;
        }

        /* Radio buttons for Section 2 */
        .radio-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: rgba(51, 65, 85, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 10px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .radio-item:hover {
            background: rgba(51, 65, 85, 0.5);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .radio-item input {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: #8b5cf6;
        }

        .radio-item label {
            cursor: pointer;
            font-size: 0.9em;
            color: #e2e8f0;
            font-weight: 500;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px;
            padding: 25px;
            transition: all 0.3s;
            animation: fadeInUp 0.8s ease both;
        }

        .chart-container.full-width {
            grid-column: 1 / -1;
        }

        .chart-container:hover {
            border-color: rgba(139, 92, 246, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-header h3 {
            font-size: 1.1em;
            font-weight: 600;
            color: #fff;
        }

        .chart-badge {
            padding: 6px 12px;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 20px;
            font-size: 0.75em;
            color: #c4b5fd;
            font-weight: 600;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .toggle-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: rgba(51, 65, 85, 0.3);
            padding: 6px;
            border-radius: 12px;
            width: fit-content;
        }

        .toggle-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: #94a3b8;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .loading {
            text-align: center;
            padding: 100px 20px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(139, 92, 246, 0.2);
            border-top-color: #8b5cf6;
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 1400px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    <div class="bg-overlay"></div>

    <div class="container">
        <div id="loadingOverlay" class="loading">
            <div class="loading-spinner"></div>
            <p style="color: #fff; font-size: 1.2em; margin-top: 20px;">Loading data...</p>
            <p style="color: #94a3b8; margin-top: 10px;">Please wait while we load 12,000+ records</p>
        </div>

        <div class="header">
            <h1>Tetra Pak Analytics Dashboard</h1>
            <p>Real-time insights and performance metrics</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Amount</div>
                <div class="stat-value" id="totalAmount">$0</div>
                <div class="stat-icon">üí∞</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Volume</div>
                <div class="stat-value" id="totalVolume">0</div>
                <div class="stat-icon">üì¶</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Transactions</div>
                <div class="stat-value" id="totalTransactions">0</div>
                <div class="stat-icon">üìä</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Suppliers</div>
                <div class="stat-value" id="totalSuppliers">0</div>
                <div class="stat-icon">üè¢</div>
            </div>
        </div>

        <!-- SECTION 1: Overtime Trend Analysis -->
        <div class="section-divider">
            <h2 class="section-title">üìà Section 1: Overtime Trend Analysis</h2>
        </div>

        <div class="filter-section with-dropdown">
            <div class="filter-header">
                <h3>üîç Select Quantity Units (Multiple Selection)</h3>
            </div>
            <div class="multi-select-container">
                <button class="multi-select-button" id="multiSelectButton">
                    <span id="multiSelectText">Select units...</span>
                    <span class="arrow">‚ñº</span>
                </button>
                <div class="multi-select-dropdown" id="multiSelectDropdown">
                    <div class="multi-select-header">
                        <span id="dropdownSelectedCount" class="selected-count">0 selected</span>
                        <div class="multi-select-actions">
                            <button onclick="selectAllSection1()">All</button>
                            <button onclick="clearAllSection1()">Clear</button>
                        </div>
                    </div>
                    <div id="unitFiltersSection1"></div>
                </div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container full-width">
                <div class="chart-header">
                    <h3 id="trendOvertimeTitle">Financial vs Volume Analysis Over Time</h3>
                    <span class="chart-badge">OVERTIME TREND</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="trendOvertimeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- SECTION 2: Detailed Analytics -->
        <div class="section-divider">
            <h2 class="section-title">üìä Section 2: Detailed Analytics by Quantity Unit</h2>
        </div>

        <div class="filter-section">
            <div class="filter-header">
                <h3>üîç Select Quantity Unit (Choose One Only)</h3>
            </div>
            <div id="unitFiltersSection2" class="radio-group"></div>
        </div>

        <div class="charts-grid">
            <!-- Top 4 Suppliers -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Top 4 Suppliers</h3>
                    <span class="chart-badge">PERFORMANCE</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="suppliersChart"></canvas>
                </div>
            </div>

            <!-- Category Distribution -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Category Distribution</h3>
                    <span class="chart-badge">BREAKDOWN</span>
                </div>
                <div class="toggle-buttons">
                    <button class="toggle-btn active" onclick="togglePieChart('amount')">Amount</button>
                    <button class="toggle-btn" onclick="togglePieChart('volume')">Volume</button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="categoryPieChart"></canvas>
                </div>
            </div>

            <!-- Top 5 Products -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 id="productsChartTitle">Top 5 Products</h3>
                    <span class="chart-badge">INTERACTIVE</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="productsChart"></canvas>
                </div>
            </div>

            <!-- Top 4 Companies Trend -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Top 4 Companies Trend Over Time</h3>
                    <span class="chart-badge">TIMELINE</span>
                </div>
                <div class="toggle-buttons">
                    <button class="toggle-btn active" onclick="toggleCompaniesTrend('amount')">Amount</button>
                    <button class="toggle-btn" onclick="toggleCompaniesTrend('volume')">Volume</button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="companiesTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let rawData = [];
        let selectedUnitsSection1 = new Set();
        let selectedUnitSection2 = null;
        let filteredDataSection2 = [];
        let charts = {};
        let pieChartMode = 'amount';
        let companiesTrendMode = 'amount';
        let selectedCategory = null;

        Chart.defaults.font.family = 'Inter, sans-serif';
        Chart.defaults.responsive = true;
        Chart.defaults.maintainAspectRatio = false;
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(148, 163, 184, 0.1)';

        async function loadData() {
            console.log('Starting to load data...');
            try {
                const response = await fetch('tetra_pak_data.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                rawData = await response.json();
                console.log(`Successfully loaded ${rawData.length} records`);

                initializeFilters();
                updateStats();

                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) loadingOverlay.style.display = 'none';

                console.log('Dashboard initialized successfully!');
            } catch (error) {
                console.error('Error:', error);
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.innerHTML = `
                        <div class="loading-spinner"></div>
                        <p style="color: #ef4444; font-size: 1.2em; margin-top: 20px;">Error loading data</p>
                        <p style="color: #94a3b8; margin-top: 10px;">Error: ${error.message}</p>
                    `;
                }
            }
        }

        function updateStats() {
            const totalAmount = rawData.reduce((sum, row) => sum + (parseFloat(row['Amount']) || 0), 0);
            const totalVolume = rawData.reduce((sum, row) => sum + (parseFloat(row['quantity']) || 0), 0);
            const totalTransactions = rawData.length;
            const uniqueSuppliers = new Set(rawData.map(row => row['Supplier'])).size;

            document.getElementById('totalAmount').textContent = '$' + totalAmount.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('totalVolume').textContent = totalVolume.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('totalTransactions').textContent = totalTransactions.toLocaleString();
            document.getElementById('totalSuppliers').textContent = uniqueSuppliers;
        }

        function initializeFilters() {
            const units = [...new Set(rawData.map(d => d['Quantity unit']))].sort();

            // Section 1 - Multi-select dropdown (checkboxes, multiple selection)
            const container1 = document.getElementById('unitFiltersSection1');
            units.forEach(unit => {
                selectedUnitsSection1.add(unit); // Select all by default

                const div = document.createElement('div');
                div.className = 'multi-select-item checked';
                div.setAttribute('data-unit', unit);

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `unit-s1-${unit}`;
                checkbox.value = unit;
                checkbox.checked = true;
                checkbox.onchange = handleSection1Change;

                const label = document.createElement('label');
                label.htmlFor = `unit-s1-${unit}`;
                label.textContent = unit;

                div.appendChild(checkbox);
                div.appendChild(label);
                container1.appendChild(div);

                div.onclick = (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        handleSection1Change({target: checkbox});
                    }
                };
            });

            // Section 2 - Radio buttons (single selection)
            const container2 = document.getElementById('unitFiltersSection2');
            units.forEach((unit, index) => {
                const div = document.createElement('div');
                div.className = 'radio-item';

                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'unitSection2';
                radio.id = `unit-s2-${unit}`;
                radio.value = unit;
                radio.checked = index === 0;
                radio.onchange = handleSection2Change;

                const label = document.createElement('label');
                label.htmlFor = `unit-s2-${unit}`;
                label.textContent = unit;

                div.appendChild(radio);
                div.appendChild(label);
                container2.appendChild(div);

                div.onclick = (e) => {
                    if (e.target !== radio) {
                        radio.checked = true;
                        handleSection2Change({target: radio});
                    }
                };

                if (index === 0) {
                    selectedUnitSection2 = unit;
                }
            });

            // Setup dropdown toggle
            setupMultiSelectDropdown();

            updateMultiSelectText();
            filteredDataSection2 = rawData.filter(d => d['Quantity unit'] === selectedUnitSection2);
            renderAllCharts();
        }

        function setupMultiSelectDropdown() {
            const button = document.getElementById('multiSelectButton');
            const dropdown = document.getElementById('multiSelectDropdown');

            button.onclick = (e) => {
                e.stopPropagation();
                button.classList.toggle('open');
                dropdown.classList.toggle('open');
            };

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target) && e.target !== button) {
                    button.classList.remove('open');
                    dropdown.classList.remove('open');
                }
            });
        }

        function updateMultiSelectText() {
            const count = selectedUnitsSection1.size;
            const total = document.querySelectorAll('#unitFiltersSection1 input[type="checkbox"]').length;
            const textElem = document.getElementById('multiSelectText');
            const countElem = document.getElementById('dropdownSelectedCount');

            if (count === 0) {
                textElem.textContent = 'No units selected';
            } else if (count === total) {
                textElem.textContent = `All units selected (${count})`;
            } else {
                const units = Array.from(selectedUnitsSection1);
                if (count <= 3) {
                    textElem.textContent = units.join(', ');
                } else {
                    textElem.textContent = `${count} units selected`;
                }
            }

            countElem.textContent = `${count} selected`;
        }

        function handleSection1Change(e) {
            const unit = e.target.value;
            const item = document.querySelector(`.multi-select-item[data-unit="${unit}"]`);

            if (e.target.checked) {
                selectedUnitsSection1.add(unit);
                item.classList.add('checked');
            } else {
                selectedUnitsSection1.delete(unit);
                item.classList.remove('checked');
            }

            updateMultiSelectText();
            renderTrendOvertimeChart();
        }

        function selectAllSection1() {
            document.querySelectorAll('#unitFiltersSection1 input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
                selectedUnitsSection1.add(cb.value);
                const item = document.querySelector(`.multi-select-item[data-unit="${cb.value}"]`);
                item.classList.add('checked');
            });
            updateMultiSelectText();
            renderTrendOvertimeChart();
        }

        function clearAllSection1() {
            document.querySelectorAll('#unitFiltersSection1 input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
                const item = document.querySelector(`.multi-select-item[data-unit="${cb.value}"]`);
                item.classList.remove('checked');
            });
            selectedUnitsSection1.clear();
            updateMultiSelectText();
            renderTrendOvertimeChart();
        }

        function handleSection2Change(e) {
            selectedUnitSection2 = e.target.value;
            filteredDataSection2 = rawData.filter(d => d['Quantity unit'] === selectedUnitSection2);
            renderSection2Charts();
        }

        function renderAllCharts() {
            renderTrendOvertimeChart();
            renderSection2Charts();
        }

        function renderSection2Charts() {
            renderSuppliersChart();
            renderCategoryPieChart();
            renderProductsChart();
            renderCompaniesTrendChart();
        }

        // SECTION 1: Overtime Trend Chart (Multiple Units)
        function renderTrendOvertimeChart() {
            const filteredData = rawData.filter(d => selectedUnitsSection1.has(d['Quantity unit']));
            const dailyData = {};

            filteredData.forEach(row => {
                const date = row['Transaction Date'];
                if (!dailyData[date]) {
                    dailyData[date] = { amount: 0, volume: 0 };
                }
                dailyData[date].amount += parseFloat(row['Amount']) || 0;
                dailyData[date].volume += parseFloat(row['quantity']) || 0;
            });

            const dates = Object.keys(dailyData).sort();
            const amounts = dates.map(date => dailyData[date].amount);
            const volumes = dates.map(date => dailyData[date].volume);

            const selectedUnitsText = selectedUnitsSection1.size === 0 ? 'No units' :
                selectedUnitsSection1.size === 1 ? Array.from(selectedUnitsSection1)[0] :
                `${selectedUnitsSection1.size} units`;

            document.getElementById('trendOvertimeTitle').textContent =
                `Financial vs Volume Analysis Over Time - ${selectedUnitsText}`;

            if (charts.trendOvertime) charts.trendOvertime.destroy();

            const ctx = document.getElementById('trendOvertimeChart').getContext('2d');
            charts.trendOvertime = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Total Amount (USD)',
                            data: amounts,
                            borderColor: '#1f77b4',
                            backgroundColor: 'rgba(31, 119, 180, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: `Quantity (${selectedUnitsText})`,
                            data: volumes,
                            borderColor: '#ff7f0e',
                            backgroundColor: 'rgba(255, 127, 14, 0.1)',
                            borderWidth: 3,
                            borderDash: [5, 5],
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#e2e8f0', padding: 15 }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#e2e8f0',
                            bodyColor: '#e2e8f0',
                            borderColor: 'rgba(139, 92, 246, 0.5)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxTicksLimit: 15,
                                color: '#94a3b8'
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Total Amount (USD)',
                                color: '#1f77b4',
                                font: { weight: 'bold', size: 14 }
                            },
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: `Quantity (${selectedUnitsText})`,
                                color: '#ff7f0e',
                                font: { weight: 'bold', size: 14 }
                            },
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // SECTION 2: Top 4 Suppliers Chart with 2 Y-axes
        function renderSuppliersChart() {
            const supplierData = {};
            filteredDataSection2.forEach(row => {
                const supplier = row['Supplier'] || 'Unknown';
                const unit = row['Quantity unit'];
                if (!supplierData[supplier]) {
                    supplierData[supplier] = { amount: 0, volume: 0, units: new Set() };
                }
                supplierData[supplier].amount += parseFloat(row['Amount']) || 0;
                supplierData[supplier].volume += parseFloat(row['quantity']) || 0;
                supplierData[supplier].units.add(unit);
            });

            const sorted = Object.entries(supplierData).sort((a, b) => b[1].amount - a[1].amount).slice(0, 4);
            const labels = sorted.map(s => s[0]);
            const amounts = sorted.map(s => s[1].amount);
            const volumes = sorted.map(s => s[1].volume);
            const units = sorted.map(s => Array.from(s[1].units).join(', '));

            if (charts.suppliers) charts.suppliers.destroy();

            const ctx = document.getElementById('suppliersChart').getContext('2d');
            charts.suppliers = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Amount (USD)',
                            data: amounts,
                            backgroundColor: 'rgba(139, 92, 246, 0.8)',
                            borderColor: 'rgba(139, 92, 246, 1)',
                            borderWidth: 2,
                            borderRadius: 8,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Volume',
                            data: volumes,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2,
                            borderRadius: 8,
                            yAxisID: 'y1',
                            units: units
                        }
                    ]
                },
                options: {
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#e2e8f0', padding: 15 }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            callbacks: {
                                afterLabel: function(context) {
                                    if (context.datasetIndex === 1) {
                                        return 'Units: ' + units[context.dataIndex];
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Amount (USD)',
                                color: '#8b5cf6',
                                font: { weight: 'bold' }
                            },
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Volume (Quantity)',
                                color: '#3b82f6',
                                font: { weight: 'bold' }
                            },
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function renderCategoryPieChart() {
            const categoryData = {};
            filteredDataSection2.forEach(row => {
                const category = row['category_group'] || 'Unknown';
                if (!categoryData[category]) {
                    categoryData[category] = { amount: 0, volume: 0 };
                }
                categoryData[category].amount += parseFloat(row['Amount']) || 0;
                categoryData[category].volume += parseFloat(row['quantity']) || 0;
            });

            const labels = Object.keys(categoryData);
            const data = labels.map(cat => pieChartMode === 'amount' ? categoryData[cat].amount : categoryData[cat].volume);
            const total = data.reduce((a, b) => a + b, 0);
            const percentages = data.map(d => ((d / total) * 100).toFixed(1));

            const colors = [
                '#8b5cf6', '#3b82f6', '#06b6d4', '#10b981', '#f59e0b',
                '#ef4444', '#ec4899', '#6366f1', '#14b8a6', '#f97316'
            ];

            if (charts.categoryPie) charts.categoryPie.destroy();

            const ctx = document.getElementById('categoryPieChart').getContext('2d');
            charts.categoryPie = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels.map((label, i) => `${label} (${percentages[i]}%)`),
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: '#1e293b',
                        borderWidth: 3
                    }]
                },
                options: {
                    plugins: {
                        legend: { position: 'right', labels: { color: '#e2e8f0', padding: 12, font: { size: 11 } } },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#e2e8f0',
                            bodyColor: '#e2e8f0',
                            borderColor: 'rgba(139, 92, 246, 0.5)',
                            borderWidth: 1
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            selectedCategory = labels[elements[0].index];
                            renderProductsChart();
                        }
                    }
                }
            });
        }

        function togglePieChart(mode) {
            pieChartMode = mode;
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderCategoryPieChart();
        }

        function renderProductsChart() {
            let dataToUse = filteredDataSection2;
            if (selectedCategory) {
                dataToUse = filteredDataSection2.filter(d => d['category_group'] === selectedCategory);
                document.getElementById('productsChartTitle').textContent = `Top 5 in ${selectedCategory}`;
            } else {
                document.getElementById('productsChartTitle').textContent = 'Top 5 Products';
            }

            const productData = {};
            dataToUse.forEach(row => {
                const product = row['standardized_name'] || 'Unknown';
                const unit = row['Quantity unit'];
                if (!productData[product]) {
                    productData[product] = { amount: 0, volume: 0, units: new Set() };
                }
                productData[product].amount += parseFloat(row['Amount']) || 0;
                productData[product].volume += parseFloat(row['quantity']) || 0;
                productData[product].units.add(unit);
            });

            const sorted = Object.entries(productData).sort((a, b) => b[1].amount - a[1].amount).slice(0, 5);
            const labels = sorted.map(s => s[0].length > 30 ? s[0].substring(0, 30) + '...' : s[0]);
            const amounts = sorted.map(s => s[1].amount);
            const volumes = sorted.map(s => s[1].volume);
            const units = sorted.map(s => Array.from(s[1].units).join(', '));

            if (charts.products) charts.products.destroy();

            const ctx = document.getElementById('productsChart').getContext('2d');
            charts.products = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Amount (USD)',
                            data: amounts,
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 2,
                            borderRadius: 8,
                            xAxisID: 'x'
                        },
                        {
                            label: 'Volume',
                            data: volumes,
                            backgroundColor: 'rgba(245, 158, 11, 0.8)',
                            borderColor: 'rgba(245, 158, 11, 1)',
                            borderWidth: 2,
                            borderRadius: 8,
                            xAxisID: 'x1'
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#e2e8f0', padding: 15 }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            callbacks: {
                                afterLabel: function(context) {
                                    if (context.datasetIndex === 1) {
                                        return 'Units: ' + units[context.dataIndex];
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            type: 'linear',
                            display: true,
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Amount (USD)',
                                color: '#10b981',
                                font: { weight: 'bold' }
                            },
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x1: {
                            type: 'linear',
                            display: true,
                            position: 'top',
                            title: {
                                display: true,
                                text: 'Volume (Quantity)',
                                color: '#f59e0b',
                                font: { weight: 'bold' }
                            },
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function toggleCompaniesTrend(mode) {
            companiesTrendMode = mode;
            const buttons = document.querySelectorAll('.chart-container:last-child .toggle-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            buttons[mode === 'amount' ? 0 : 1].classList.add('active');
            renderCompaniesTrendChart();
        }

        function renderCompaniesTrendChart() {
            const supplierTotals = {};
            filteredDataSection2.forEach(row => {
                const supplier = row['Supplier'] || 'Unknown';
                supplierTotals[supplier] = (supplierTotals[supplier] || 0) + (parseFloat(row['Amount']) || 0);
            });

            const top4Suppliers = Object.entries(supplierTotals).sort((a, b) => b[1] - a[1]).slice(0, 4).map(s => s[0]);
            const dateData = {};

            filteredDataSection2.forEach(row => {
                const supplier = row['Supplier'] || 'Unknown';
                if (!top4Suppliers.includes(supplier)) return;
                const date = row['Transaction Date'];
                if (!dateData[date]) dateData[date] = {};
                if (!dateData[date][supplier]) dateData[date][supplier] = { amount: 0, volume: 0 };
                dateData[date][supplier].amount += parseFloat(row['Amount']) || 0;
                dateData[date][supplier].volume += parseFloat(row['quantity']) || 0;
            });

            const dates = Object.keys(dateData).sort();
            const colors = ['#8b5cf6', '#3b82f6', '#10b981', '#f59e0b'];

            const datasets = [];
            top4Suppliers.forEach((supplier, index) => {
                const data = dates.map(date =>
                    companiesTrendMode === 'amount'
                        ? (dateData[date][supplier]?.amount || 0)
                        : (dateData[date][supplier]?.volume || 0)
                );

                datasets.push({
                    label: supplier,
                    data: data,
                    borderColor: colors[index],
                    backgroundColor: colors[index],
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4
                });
            });

            if (charts.companiesTrend) charts.companiesTrend.destroy();

            const ctx = document.getElementById('companiesTrendChart').getContext('2d');
            charts.companiesTrend = new Chart(ctx, {
                type: 'line',
                data: { labels: dates, datasets: datasets },
                options: {
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#e2e8f0', boxWidth: 20, font: { size: 12 }, padding: 15 }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#e2e8f0',
                            bodyColor: '#e2e8f0',
                            borderColor: 'rgba(139, 92, 246, 0.5)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: { maxTicksLimit: 10, maxRotation: 45, minRotation: 45, color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: companiesTrendMode === 'amount' ? 'Amount (USD)' : 'Volume (Quantity)',
                                color: '#8b5cf6',
                                font: { weight: 'bold', size: 14 }
                            },
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        loadData();
    </script>
</body>
</html>
